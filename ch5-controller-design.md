#### 1.转速PID控制

关于PID控制器的解释可以看看知乎的这篇回答https://www.zhihu.com/question/23088613

PID控制器应该怎么设计，各种玩家各种玩法，

* 土鳖玩法：不停地试凑PID参数，改一次，烧一次程序，然后放赛道上测试，跟着感觉走，老铁
* 折中玩法：先搞到系统模型，然后Simulink搭建仿真环境，在仿真里试凑，然后是的差不多了，再放赛道进行真实测试
* 高级玩法：硬件在环或者直接MBD设计

我们就用智能车的转速PI控制器来跟大家说一下，这里采用的是折中玩法，首先是测得被控对象的模型，在这之前，我们先要搞清楚被控对象输入输出是什么，智能车要控制车速，控制量是PWM输出，所以我们要得到一个PWM占空比输出到车速的系统模型，如果要推公式的话，那叽里呱啦一大堆，有没有什么简单易行的方法呢？？废话，当然有呀，还记不记得学自控原理，我们要得到系统的传递函数，可以给系统加不同的激励输入，然后测输出反应，这里我们选择加阶跃输入，具体玩法是什么呢：

1. 做一条长约10m的长直赛道
2. 方向控制要有，保证车沿长直赛道行驶
3. 代码设定PWM占空比25%，恒定不变，不加入任何速度控制
4. 系统上电，车开始加速行驶，直到速度稳定
5. 从系统上电开始，每隔一个时间在Log记录一下当前速度（可以选定10ms）
6. 全部跑完之后，将Log记录的数据导出到电脑里，matlab开始建模

这里就用到了我们ch6中的测试Log模块，在ch6会详细解释。

然后就会得到这样一张图

![](/assets/EmbeddedSystem_S5_P0.png)



#### 2.转向PD控制器

PID控制器设计分不同的套路，一种是经验口诀整定，一种是经验公式整定，总之各有各的玄妙。

我们就从最简单的小电动车聊起，说简单就是锂电池配直流电机，30V的锂电池，加到电机上，转速3000rpm，然后我们把轮子加上空转，转速降到2500rpm，把小车放到地上跑，转速又降到1000rpm，人背东西走的也慢，电机也一个样，这个转速折算成车速就是10km/h，速度太慢了，得想办法调快点，于是把锂电池多串上几条，电压加到100V，到了30km/h，这速度还行。现在是100V电压，30km/h，平路行驶，妥妥地老司机开车，啥事没有。

这时候有一个问题，就是电池一旦串好，就不能改工作电压了，只能听天由命跑完全程，这哪里是老司机嘛？？？？明明就是一根筋的二愣子。于是搞电力电子的兄弟们发明了一种简单方法，比如现在电池只有100V电压，那可以这样玩，加个电子开关，给电机通电5ms100V，再断开5ms，然后依次循环，只要频率足够快就没啥事，这样等效下来是不是就相当于50V电压呀，然后通过调节开通关断时间比例，来连续调节电压，这就叫做PWM控制。简单点说，**有了PWM调节，我们的电动车就可以调压调速了**。

老司机心想，设定好一个70V电压，20km/h兜风模式，就让车自己跑吧，老子才懒得一直调电压呢，然后就：

* 路上接了一个大帅哥和一个大美女，他们一上车，车速慢了，咋整呀？？？
* 随着车辆行驶电池耗电，电压不断在下降，车速也不断在变慢，咋整呀？？
* 进了山区，路况不好，上坡时，速度贼慢，下坡时，速度又贼快，咋整呀？？？

总会遇到突发意外情况，老司机心想这调起来还有点麻烦：帅哥美女上来，负载增加了，车速降了，得加点电压；电池消耗电压下降，导致车速慢了，也得加点电压；上坡负载变大，车速下降，得加点电压，下坡负载变小，车速增快，得降点电压。老司机心想，这么多意外情况都要调PWM电压，那不把脑细胞烧死呀，得想想办法。思来想去，发现既然要控制车速20km/h，降了加电压，升了减电压，那直接用设定车速与实际车速的偏差值，去控制电压不就得了，差的多就多加点电压，差的少就少加点电压，这就是**比例控制器，用当前的速度偏差作为控制量，加到电机上，同样的速度偏差量，多加点还是少加点电压，就是比例系数，加少了，响应慢，加多了，车会震起来的，哈哈。**

这里要注意，单纯的比例控制，需要用速度偏差比例放大得到控制电压，这就意味着，要想跑20km/h，得有控制电压70V，那就必须一定要有速度偏差，这就意味着，不管你怎么调节比例系数，永远都达不到设定的20km/h，不过调大比例系数，这个偏差会变小。**比例控制里这个无法消去的速度偏差，在控制系统里称为静差**。

老司机在想，该怎么消除这个静差呢？？？话说，直男眼里容不得一粒沙子呀

既然这个偏差一直存在，当前偏差已经用于比例控制，那是不是可以累积偏差，作为控制量，只要有偏差就一直累积，直到偏差为0，这在控制系统里称为**积分控制**。这玩意虽然能够消除静差，但是带来新的问题，累积快了会导致加多了产生响应超调，累加慢了会导致静差消除的倍儿慢。那多快比较合适呢，建议将积分比例系数Ki选择为接近系统的固有频率Wn比较合适，简单点说，就是积分的响应最好是比系统的动态特性略快点，这样就好比润物细无声。

我们通过的这些情况，我们在做任何系统设计的时候，都会遇到类似的意外情况。不管是外界的负载变化，还是内部的电源变化，都需要我们去平衡，而这种情况下，

从直流电机转速控制开始聊起，一切条件均理想，当我们给空载的直流电机两端加30V电压的时候，我们测得直流电机3000 rpm（3000转每分钟），现在让这个电机带动一辆车空转，转速降到了2500rpm，把车放到地上跑，转速又降到1000rpm，人背东西走的也慢，电机也一个鸟样。为了达到理想行驶效果，需要转速稳定运行在1500rpm（30km/h），通过手动试凑调节电压，最后确定45V可以稳定在1500rpm，然后我们就觉得一切OK了，可以去喝茶了，让电机自己在那搅拌吧。

随着饲料搅拌的均匀，负载变低，转速升上去了，要赶快降电压。冬天，温度低，饲料刚开始变稠了，转速又降了。还有各种意外情况，每出现

